<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Quintessence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;background:#06060f;overflow:hidden;font-family:'Georgia','Times New Roman',serif}
#root{width:100%;height:100%;display:flex}
button{font-family:inherit;outline:none;border:none;cursor:pointer}
button:active{opacity:.72;transform:scale(.96)}
input[type=range]{accent-color:#FFB300}
::-webkit-scrollbar{width:3px;background:#08080f}
::-webkit-scrollbar-thumb{background:#1e1e30;border-radius:3px}
@keyframes glowPulse{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes correctFlash{0%{transform:scale(1)}40%{transform:scale(1.06)}100%{transform:scale(1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.slide-up{animation:slideUp .22s ease forwards}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

// ═══════════════════════════════════════════════════════════════════
// MUSIC THEORY CORE
// ═══════════════════════════════════════════════════════════════════

const NOTES=['C','C♯','D','D♯','E','F','F♯','G','G♯','A','A♯','B'];
const NOTES_FLAT=['C','D♭','D','E♭','E','F','G♭','G','A♭','A','B♭','B'];

// Semitone lookup (both notations)
const ST={
  'C':0,'C#':1,'C♯':1,'Db':1,'D♭':1,'D':2,'D#':3,'D♯':3,'Eb':3,'E♭':3,'E':4,
  'F':5,'F#':6,'F♯':6,'Gb':6,'G♭':6,'G':7,'G#':8,'G♯':8,'Ab':8,'A♭':8,
  'A':9,'A#':10,'A♯':10,'Bb':10,'B♭':10,'B':11
};
function st(n){return ST[n]??-1}
function noteName(s,preferFlat=false){return preferFlat?NOTES_FLAT[s]:NOTES[s]}

// Chord formulas [semitone offsets from root]
const CHORD_FORMULAS={
  maj:    {intervals:[0,4,7],     symbol:'',    name:'Majeur'},
  maj7:   {intervals:[0,4,7,11],  symbol:'maj7',name:'Majeur 7'},
  maj6:   {intervals:[0,4,7,9],   symbol:'6',   name:'Majeur 6'},
  min:    {intervals:[0,3,7],     symbol:'m',   name:'Mineur'},
  min7:   {intervals:[0,3,7,10],  symbol:'m7',  name:'Mineur 7'},
  min6:   {intervals:[0,3,7,9],   symbol:'m6',  name:'Mineur 6'},
  min7b5: {intervals:[0,3,6,10],  symbol:'m7♭5',name:'Demi-diminué'},
  dom7:   {intervals:[0,4,7,10],  symbol:'7',   name:'Dominante 7'},
  dom9:   {intervals:[0,4,7,10,14],symbol:'9',  name:'Dominante 9'},
  dim:    {intervals:[0,3,6],     symbol:'dim', name:'Diminué'},
  dim7:   {intervals:[0,3,6,9],   symbol:'dim7',name:'Diminué 7'},
  aug:    {intervals:[0,4,8],     symbol:'aug', name:'Augmenté'},
  sus2:   {intervals:[0,2,7],     symbol:'sus2',name:'Suspendu 2'},
  sus4:   {intervals:[0,5,7],     symbol:'sus4',name:'Suspendu 4'},
  dom7s11:{intervals:[0,4,7,10,18],symbol:'7♯11',name:'Lydien dominant'},
};

// Scale formulas + description
const SCALES={
  ionian:    {name:'Ionien (Majeur)',   formula:[0,2,4,5,7,9,11], color:'#FFB300'},
  dorian:    {name:'Dorien',            formula:[0,2,3,5,7,9,10],  color:'#00BCD4'},
  phrygian:  {name:'Phrygien',          formula:[0,1,3,5,7,8,10],  color:'#E040FB'},
  lydian:    {name:'Lydien',            formula:[0,2,4,6,7,9,11],  color:'#FF6D00'},
  mixolydian:{name:'Mixolydien',        formula:[0,2,4,5,7,9,10],  color:'#FF4081'},
  aeolian:   {name:'Éolien (Mineur nat.)',formula:[0,2,3,5,7,8,10],color:'#76FF03'},
  locrian:   {name:'Locrien',           formula:[0,1,3,5,6,8,10],  color:'#FF1744'},
  harm_min:  {name:'Mineur harmonique', formula:[0,2,3,5,7,8,11],  color:'#69F0AE'},
  mel_min:   {name:'Mineur mélodique',  formula:[0,2,3,5,7,9,11],  color:'#40C4FF'},
  blues_maj: {name:'Blues majeur',      formula:[0,2,3,4,7,9],     color:'#FFEA00'},
  blues_min: {name:'Blues mineur',      formula:[0,3,5,6,7,10],    color:'#FF6E40'},
  pentatonic_maj:{name:'Pentatonique maj.',formula:[0,2,4,7,9],    color:'#FFB300'},
  pentatonic_min:{name:'Pentatonique min.',formula:[0,3,5,7,10],   color:'#69F0AE'},
  whole_tone:{name:'Tons entiers',      formula:[0,2,4,6,8,10],    color:'#EA80FC'},
  dim_sym:   {name:'Dim. symétrique (t-s)',formula:[0,2,3,5,6,8,9,11],color:'#1DE9B6'},
  dim_sym2:  {name:'Dim. symétrique (s-t)',formula:[0,1,3,4,6,7,9,10],color:'#1DE9B6'},
  lyd_dom:   {name:'Lydien dominant',   formula:[0,2,4,6,7,9,10],  color:'#FF6D00'},
  alt:       {name:'Altérée (Super-Locrien)',formula:[0,1,3,4,6,8,10],color:'#FF1744'},
  phrygdom:  {name:'Phrygien dominant', formula:[0,1,4,5,7,8,10],  color:'#E040FB'},
};

// Scale suggestions per chord type (ordered by relevance)
const CHORD_SCALES={
  maj:    ['ionian','lydian','pentatonic_maj','blues_maj'],
  maj7:   ['ionian','lydian','pentatonic_maj'],
  maj6:   ['ionian','lydian','pentatonic_maj'],
  min:    ['aeolian','dorian','pentatonic_min','blues_min'],
  min7:   ['dorian','aeolian','pentatonic_min','blues_min'],
  min6:   ['dorian','mel_min'],
  min7b5: ['locrian','mel_min'],
  dom7:   ['mixolydian','blues_min','pentatonic_min','pentatonic_maj','lyd_dom','alt'],
  dom9:   ['mixolydian','lyd_dom','pentatonic_maj'],
  dim:    ['dim_sym','locrian'],
  dim7:   ['dim_sym2','dim_sym'],
  aug:    ['whole_tone','mel_min'],
  sus2:   ['ionian','mixolydian'],
  sus4:   ['mixolydian','dorian'],
  dom7s11:['lyd_dom','whole_tone'],
};

// Build chord label from root semitone + type
function chordLabel(root, type, preferFlat=true){
  const n=noteName(root, preferFlat);
  const sym=CHORD_FORMULAS[type]?.symbol??type;
  return n+sym;
}

// Get scale notes for root + scale key
function scaleNotes(root, scaleKey, preferFlat=true){
  const formula=SCALES[scaleKey]?.formula??[];
  return formula.map(offset=>noteName((root+offset)%12, preferFlat));
}

// FFT Chord Detection
function buildChroma(freqData, sampleRate, fftSize){
  const chroma=new Float32Array(12).fill(0);
  const binHz=sampleRate/fftSize;
  for(let i=1;i<freqData.length;i++){
    const freq=i*binHz;
    if(freq<55||freq>3000)continue;
    const amp=Math.pow(10,freqData[i]/20);
    const midi=12*Math.log2(freq/440)+69;
    const pc=((Math.round(midi)%12)+12)%12;
    chroma[pc]+=amp;
  }
  const max=Math.max(...chroma,.001);
  return chroma.map(v=>v/max);
}

function scoreChord(chroma,root,template){
  let score=0;
  for(const offset of template) score+=chroma[(root+offset)%12];
  let penalty=0;
  for(let i=0;i<12;i++) if(!template.includes(((i-root)+12)%12)) penalty+=chroma[i]*.25;
  return score/template.length-penalty;
}

function detectChord(chroma){
  let best={root:0,type:'maj',score:-Infinity};
  for(let root=0;root<12;root++){
    for(const [type,{intervals}] of Object.entries(CHORD_FORMULAS)){
      const s=scoreChord(chroma,root,intervals);
      if(s>best.score) best={root,type,score:s};
    }
  }
  if(best.score<0.2) return null;
  return {...best, label:chordLabel(best.root,best.type)};
}

// ═══════════════════════════════════════════════════════════════════
// PROGRESSIONS LIBRARY
// ═══════════════════════════════════════════════════════════════════

// A chord in a progression: {root (semitone), type, beats? (override beatsPerChord)}
// Progressions can be 'transposable' = repeat in all 12 keys cycling

function buildProgression(chords){return chords;}

const PROGRESSIONS=[
// ── Cycle des quintes ───────────────────────────────────────────
{id:'cycle_maj',  cat:'Cycle',  name:'Cycle ↻ Majeur',   desc:'12 quintes ascendantes – accords majeurs',
 chords:[0,7,2,9,4,11,6,1,8,3,10,5].map(r=>({root:r,type:'maj'}))},

{id:'cycle_maj7', cat:'Cycle',  name:'Cycle ↻ Maj7',    desc:'Cycle des quintes – voicings maj7',
 chords:[0,7,2,9,4,11,6,1,8,3,10,5].map(r=>({root:r,type:'maj7'}))},

{id:'cycle_dom7', cat:'Cycle',  name:'Cycle ↻ Dom7',    desc:'Tensions dominantes enchaînées',
 chords:[0,7,2,9,4,11,6,1,8,3,10,5].map(r=>({root:r,type:'dom7'}))},

{id:'cycle_min7', cat:'Cycle',  name:'Cycle ↻ Min7',    desc:'Cycle des quintes – accords mineurs 7',
 chords:[0,7,2,9,4,11,6,1,8,3,10,5].map(r=>({root:r,type:'min7'}))},

{id:'cycle_ccw',  cat:'Cycle',  name:'Cycle ↺ (Quartes)',desc:'Mouvement par quartes',
 chords:[0,5,10,3,8,1,6,11,4,9,2,7].map(r=>({root:r,type:'maj'}))},

// ── Jazz II-V-I ──────────────────────────────────────────────────
{id:'251_maj_c',  cat:'Jazz',   name:'II–V–I Majeur (C)', desc:'Dm7 – G7 – Cmaj7, le mouvement fondamental du jazz',
 chords:[{root:2,type:'min7'},{root:7,type:'dom7'},{root:0,type:'maj7'}]},

{id:'251_maj_all',cat:'Jazz',   name:'II–V–I Majeur (12 tons)',desc:'II–V–I qui descend par quintes dans toutes les tonalités',
 chords:[
  {root:2,type:'min7'},{root:7,type:'dom7'},{root:0,type:'maj7'},
  {root:9,type:'min7'},{root:2,type:'dom7'},{root:7,type:'maj7'},
  {root:4,type:'min7'},{root:9,type:'dom7'},{root:2,type:'maj7'},
  {root:11,type:'min7'},{root:4,type:'dom7'},{root:9,type:'maj7'},
 ]},

{id:'251_min_c',  cat:'Jazz',   name:'II–V–I Mineur (C)', desc:'Dm7♭5 – G7 – Cm',
 chords:[{root:2,type:'min7b5'},{root:7,type:'dom7'},{root:0,type:'min'}]},

{id:'anatole',    cat:'Jazz',   name:'Anatole (Rhythm Changes)',desc:'Cmaj7 – Am7 – Dm7 – G7, base du bebop',
 chords:[{root:0,type:'maj7'},{root:9,type:'min7'},{root:2,type:'min7'},{root:7,type:'dom7'}]},

{id:'coltrane',   cat:'Jazz',   name:'Coltrane Changes',  desc:'Substitutions par tierces majeures',
 chords:[
  {root:0,type:'maj7'},{root:4,type:'dom7'},
  {root:8,type:'maj7'},{root:0,type:'dom7'},
  {root:4,type:'maj7'},{root:8,type:'dom7'},
 ]},

{id:'giant_steps',cat:'Jazz',   name:'Giant Steps (Coltrane)',desc:'Progression ultra-chromatique en tierces maj.',
 chords:[
  {root:11,type:'maj'},{root:7,type:'dom7'},{root:0,type:'maj'},
  {root:8,type:'dom7'},{root:4,type:'maj'},{root:0,type:'dom7'},
  {root:4,type:'maj'},{root:11,type:'dom7'},{root:7,type:'maj'},
  {root:3,type:'dom7'},{root:0,type:'maj'},{root:8,type:'dom7'},
 ]},

{id:'all_the_things',cat:'Jazz',name:'All The Things (extrait)',desc:'Classique jazz – II–V–I enchaînés',
 chords:[
  {root:4,type:'min7'},{root:9,type:'dom7'},{root:3,type:'maj7'},
  {root:0,type:'min7'},{root:5,type:'dom7'},{root:9,type:'maj7'},
  {root:2,type:'min7b5'},{root:7,type:'dom7'},{root:0,type:'maj7'},
 ]},

{id:'stella',     cat:'Jazz',   name:'Stella by Starlight (extrait)',desc:'Harmonies riches du standard',
 chords:[
  {root:11,type:'min7b5'},{root:4,type:'dom7'},{root:0,type:'maj7'},
  {root:2,type:'min7'},{root:7,type:'dom7'},{root:0,type:'maj7'},
  {root:5,type:'min7'},{root:10,type:'dom7'},
 ]},

// ── Blues ────────────────────────────────────────────────────────
{id:'blues_12_c', cat:'Blues',  name:'Blues 12 mesures (C)',desc:'I7–IV7–V7, la forme blues canonique',
 chords:[
  {root:0,type:'dom7'},{root:0,type:'dom7'},{root:0,type:'dom7'},{root:0,type:'dom7'},
  {root:5,type:'dom7'},{root:5,type:'dom7'},{root:0,type:'dom7'},{root:0,type:'dom7'},
  {root:7,type:'dom7'},{root:5,type:'dom7'},{root:0,type:'dom7'},{root:7,type:'dom7'},
 ]},

{id:'jazz_blues_c',cat:'Blues', name:'Jazz Blues (C)',      desc:'Blues sophistiqué avec substitutions',
 chords:[
  {root:0,type:'dom7'},{root:5,type:'dom7'},{root:0,type:'dom7'},{root:0,type:'dom7'},
  {root:5,type:'dom7'},{root:5,type:'dom7'},{root:0,type:'dom7'},{root:9,type:'min7'},
  {root:2,type:'min7'},{root:7,type:'dom7'},{root:0,type:'dom7'},{root:2,type:'min7'},
 ]},

{id:'bird_blues_c',cat:'Blues', name:'Bird Blues (C)',     desc:'Progression bebop de Charlie Parker',
 chords:[
  {root:0,type:'maj7'},{root:5,type:'dom7'},{root:0,type:'maj7'},{root:2,type:'min7'},
  {root:5,type:'dom7'},{root:5,type:'dom9'},{root:5,type:'dom7'},{root:0,type:'maj7'},
  {root:9,type:'min7'},{root:2,type:'dom7'},{root:0,type:'maj7'},{root:7,type:'dom7'},
 ]},

// ── Modal ────────────────────────────────────────────────────────
{id:'modal_dorian',cat:'Modal', name:'Pedal Dorien',       desc:'Oscillation Dm7–Em7 façon Miles Davis',
 chords:[{root:2,type:'min7'},{root:4,type:'min7'}]},

{id:'modal_so_what',cat:'Modal',name:'So What (extrait)',  desc:'II–I Dorien – le modal par excellence',
 chords:[{root:2,type:'min7'},{root:2,type:'min7'},{root:3,type:'min7'},{root:2,type:'min7'}]},

{id:'modal_phrygian',cat:'Modal',name:'Phrygien flamenco', desc:'Em – Fmaj – Em tension espagnole',
 chords:[{root:4,type:'min'},{root:5,type:'maj'},{root:4,type:'min'},{root:3,type:'maj'}]},

{id:'modal_lydian',cat:'Modal', name:'Lydien statique',   desc:'Flottement lydien – Cmaj7/D',
 chords:[{root:0,type:'maj7'},{root:2,type:'dom7'},{root:0,type:'maj7'},{root:2,type:'dom7'}]},

// ── Pop / Rock ───────────────────────────────────────────────────
{id:'pop_1456',   cat:'Pop',    name:'I–IV–V–VI mineur',  desc:'Progression pop la plus utilisée',
 chords:[{root:0,type:'maj'},{root:5,type:'maj'},{root:7,type:'maj'},{root:9,type:'min'}]},

{id:'pop_6451',   cat:'Pop',    name:'VI–IV–I–V',         desc:'Variante émotionnelle – Pachelbel mod.',
 chords:[{root:9,type:'min'},{root:5,type:'maj'},{root:0,type:'maj'},{root:7,type:'maj'}]},

{id:'pop_1564',   cat:'Pop',    name:'I–V–VI–IV',         desc:'Axis progression (Axis of awesome)',
 chords:[{root:0,type:'maj'},{root:7,type:'maj'},{root:9,type:'min'},{root:5,type:'maj'}]},

{id:'andalusian', cat:'Pop',    name:'Cadence andalouse',  desc:'Am–G–F–E, tension méditerranéenne',
 chords:[{root:9,type:'min'},{root:7,type:'maj'},{root:5,type:'maj'},{root:4,type:'maj'}]},

// ── Modes avancés ────────────────────────────────────────────────
{id:'tritone_sub',cat:'Avancé', name:'Substitutions tritoniques',desc:'Substitutions de dominantes à distance de triton',
 chords:[
  {root:2,type:'min7'},{root:1,type:'dom7'},{root:0,type:'maj7'},
  {root:9,type:'min7'},{root:8,type:'dom7'},{root:7,type:'maj7'},
 ]},

{id:'dim_cycle',  cat:'Avancé', name:'Cycle diminué',     desc:'Substitutions par accords dim7 (symétrie)',
 chords:[
  {root:0,type:'dim7'},{root:3,type:'dim7'},{root:6,type:'dim7'},{root:9,type:'dim7'},
 ]},

{id:'aug_cycle',  cat:'Avancé', name:'Cycle augmenté',    desc:'Tierces majeures – symétrie par 3',
 chords:[
  {root:0,type:'aug'},{root:4,type:'aug'},{root:8,type:'aug'},
 ]},

{id:'chain_dom',  cat:'Avancé', name:'Chaîne de dominantes',desc:'Dominantes secondaires enchaînées',
 chords:[
  {root:4,type:'dom7'},{root:9,type:'dom7'},{root:2,type:'dom7'},
  {root:7,type:'dom7'},{root:0,type:'dom7'},
 ]},

{id:'minor_251_cycle',cat:'Avancé',name:'II–V–I mineur cycle',desc:'II–V–I mineur dans 4 tonalités',
 chords:[
  {root:2,type:'min7b5'},{root:7,type:'dom7'},{root:0,type:'min'},
  {root:9,type:'min7b5'},{root:2,type:'dom7'},{root:7,type:'min'},
  {root:4,type:'min7b5'},{root:11,type:'dom7'},{root:4,type:'min'},
  {root:11,type:'min7b5'},{root:6,type:'dom7'},{root:11,type:'min'},
 ]},

{id:'interp',     cat:'Avancé', name:'Interpolations II–V', desc:'II–V intercalés avant chaque accord',
 chords:[
  {root:9,type:'min7'},{root:2,type:'dom7'},
  {root:4,type:'min7'},{root:9,type:'dom7'},
  {root:2,type:'min7'},{root:7,type:'dom7'},{root:0,type:'maj7'},
 ]},
];

const CATEGORIES=[...new Set(PROGRESSIONS.map(p=>p.cat))];

// ═══════════════════════════════════════════════════════════════════
// AUDIO HELPERS
// ═══════════════════════════════════════════════════════════════════

function playClick(ctx,isDown,vol=0.6){
  if(!ctx||ctx.state==='closed')return;
  const t=ctx.currentTime;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type='triangle';
  o.frequency.value=isDown?1400:900;
  g.gain.setValueAtTime(vol,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+0.035);
  o.connect(g);g.connect(ctx.destination);
  o.start(t);o.stop(t+0.04);
}

// ═══════════════════════════════════════════════════════════════════
// SESSION STORAGE
// ═══════════════════════════════════════════════════════════════════

const SK='quintessence_v3_sessions';
const loadSessions=()=>{try{return JSON.parse(localStorage.getItem(SK)||'[]');}catch{return [];}};
const saveSess=s=>{try{const a=loadSessions();a.unshift({...s,id:Date.now(),date:new Date().toISOString()});localStorage.setItem(SK,JSON.stringify(a.slice(0,60)));}catch{}};
const clearSess=()=>{try{localStorage.removeItem(SK);}catch{}};

// ═══════════════════════════════════════════════════════════════════
// CIRCLE COMPONENT
// ═══════════════════════════════════════════════════════════════════

const COL=['#FFB300','#FF6D00','#E040FB','#00BCD4','#76FF03','#FF4081',
           '#40C4FF','#FFEA00','#69F0AE','#FF6E40','#EA80FC','#1DE9B6'];
const MAJ_ROOTS=[0,7,2,9,4,11,6,1,8,3,10,5]; // circle of fifths order
const MAJ_LABELS=['C','G','D','A','E','B','F♯','D♭','A♭','E♭','B♭','F'];
const MIN_LABELS=['Am','Em','Bm','F♯m','C♯m','G♯m','D♯m','B♭m','Fm','Cm','Gm','Dm'];

function CircleSVG({size, currentRoot, nextRoot, chordType, noteStatus, activeRoots}){
  const cx=size/2, cy=size/2;
  const outerR=size*.42, midR=size*.315, innerR=size*.22;
  const outerLbl=size*.37, innerLbl=size*.265;
  const statusColor=noteStatus==='correct'?'#00E676':noteStatus==='wrong'?'#FF1744':'#FFB300';

  return(
    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} style={{overflow:'visible'}}>
      <defs>
        <radialGradient id="cbg" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stopColor="#12101e"/>
          <stop offset="100%" stopColor="#06060f"/>
        </radialGradient>
        <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="4" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
        <filter id="sg" x="-60%" y="-60%" width="220%" height="220%">
          <feGaussianBlur stdDeviation="8" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>

      <circle cx={cx} cy={cy} r={outerR+size*.05} fill="url(#cbg)" stroke="#101020" strokeWidth="1"/>

      {MAJ_ROOTS.map((root,i)=>{
        const a0=(i*30-90)*Math.PI/180;
        const a1=((i+1)*30-90)*Math.PI/180;
        const mid=(i*30+15-90)*Math.PI/180;
        const col=COL[i];
        const isCur=root===currentRoot;
        const isNxt=root===nextRoot&&root!==currentRoot;
        const inAct=activeRoots?.has(root);

        const P=(r,a)=>[cx+r*Math.cos(a),cy+r*Math.sin(a)];
        const [x1o,y1o]=P(outerR,a0),[x2o,y2o]=P(outerR,a1);
        const [x1m,y1m]=P(midR,a0), [x2m,y2m]=P(midR,a1);
        const [x1n,y1n]=P(innerR,a0),[x2n,y2n]=P(innerR,a1);

        const outerPath=`M${x1m} ${y1m} L${x1o} ${y1o} A${outerR} ${outerR} 0 0 1 ${x2o} ${y2o} L${x2m} ${y2m} A${midR} ${midR} 0 0 0 ${x1m} ${y1m}`;
        const innerPath=`M${x1n} ${y1n} L${x1m} ${y1m} A${midR} ${midR} 0 0 1 ${x2m} ${y2m} L${x2n} ${y2n} A${innerR} ${innerR} 0 0 0 ${x1n} ${y1n}`;

        const [lx,ly]=P(outerLbl,mid);
        const [mx,my]=P(innerLbl,mid);

        return(
          <g key={i}>
            <path d={outerPath}
              fill={isCur?col+'ee':isNxt?col+'40':inAct?col+'20':'#0c0c18'}
              stroke={isCur?col:isNxt?col+'80':inAct?col+'50':'#181828'}
              strokeWidth={isCur?2:.5}
              style={{filter:isCur?'url(#glow)':'none',transition:'all .15s'}}/>
            <path d={innerPath}
              fill={isCur?col+'55':isNxt?col+'25':inAct?col+'12':'#09090f'}
              stroke={isCur?col+'aa':inAct?col+'30':'#121220'}
              strokeWidth={isCur?1:.5}
              style={{filter:isCur?'url(#glow)':'none',transition:'all .15s'}}/>
            <text x={lx} y={ly} textAnchor="middle" dominantBaseline="middle"
              fontSize={isCur?size*.048:size*.036} fontWeight={isCur?700:inAct?500:300}
              fill={isCur?'#fff':isNxt?'#bbb':inAct?col:'#2a2a3e'}
              style={{filter:isCur?'url(#glow)':'none',transition:'fill .15s'}}
              fontFamily="Georgia,serif"
            >{MAJ_LABELS[i]}</text>
            <text x={mx} y={my} textAnchor="middle" dominantBaseline="middle"
              fontSize={isCur?size*.03:size*.024} fontWeight={isCur?600:300}
              fill={isCur?'#8ecba8':inAct?col+'88':'#1e1e30'}
              style={{transition:'fill .15s'}}
              fontFamily="Georgia,serif"
            >{MIN_LABELS[i]}</text>
          </g>
        );
      })}

      {/* Center */}
      <circle cx={cx} cy={cy} r={innerR-size*.012} fill="#06060f" stroke="#141428" strokeWidth="1"/>
      {noteStatus!=='idle'&&<>
        <circle cx={cx} cy={cy} r={innerR-size*.015} fill="none"
          stroke={statusColor} strokeWidth="1.5" strokeOpacity=".35"
          style={{filter:'url(#sg)',animation:'glowPulse 1.5s infinite'}}/>
      </>}
      {currentRoot!=null&&noteStatus!=='idle'?(
        <>
          <text x={cx} y={cy-size*.025} textAnchor="middle" dominantBaseline="middle"
            fontSize={size*.085} fontWeight={200} fill={statusColor}
            fontFamily="Georgia,serif" style={{filter:noteStatus==='correct'?'url(#sg)':'none',transition:'fill .15s'}}>
            {chordLabel(currentRoot,chordType)}
          </text>
          <text x={cx} y={cy+size*.055} textAnchor="middle" dominantBaseline="middle"
            fontSize={size*.025} fill={statusColor+'99'} letterSpacing="2"
            fontFamily="Georgia,serif">
            {noteStatus==='correct'?'CORRECT':noteStatus==='wrong'?'RATÉ':'ÉCOUTE'}
          </text>
        </>
      ):(
        <text x={cx} y={cy} textAnchor="middle" dominantBaseline="middle"
          fontSize={size*.028} fill="#1e1e30" letterSpacing="3" fontFamily="Georgia,serif">
          QUINTESSENCE
        </text>
      )}
    </svg>
  );
}

// ═══════════════════════════════════════════════════════════════════
// SCALE DISPLAY COMPONENT
// ═══════════════════════════════════════════════════════════════════

function ScaleDisplay({root, chordType, scaleIndex, onCycleScale}){
  if(root==null||!chordType)return null;
  const scaleKeys=CHORD_SCALES[chordType]||['ionian'];
  const idx=Math.min(scaleIndex,scaleKeys.length-1);
  const scaleKey=scaleKeys[idx];
  const scaleInfo=SCALES[scaleKey];
  if(!scaleInfo)return null;
  const notes=scaleNotes(root,scaleKey);
  const preferFlat=[1,3,5,6,8,10].includes(root);

  return(
    <div style={{display:'flex',flexDirection:'column',gap:6}}>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div>
          <div style={{fontSize:9,letterSpacing:3,color:'#3a3a4e',marginBottom:1}}>GAMME SUGGÉRÉE</div>
          <div style={{fontSize:13,color:scaleInfo.color,fontWeight:600,letterSpacing:.5}}>
            {scaleInfo.name}
          </div>
        </div>
        <div style={{display:'flex',gap:4,alignItems:'center'}}>
          {scaleKeys.length>1&&(
            <div style={{display:'flex',gap:3}}>
              {scaleKeys.map((_,i)=>(
                <div key={i} style={{
                  width:6,height:6,borderRadius:'50%',
                  background:i===idx?scaleInfo.color:'#1a1a28',
                  border:i===idx?'none':'1px solid #252535',
                  cursor:'pointer',transition:'all .15s',
                }} onClick={onCycleScale}/>
              ))}
            </div>
          )}
          {scaleKeys.length>1&&(
            <button onClick={onCycleScale}
              style={{padding:'3px 8px',borderRadius:6,background:'rgba(255,255,255,.04)',
                border:'1px solid #1e1e2e',color:'#555',fontSize:9,cursor:'pointer',letterSpacing:1}}>
              {idx+1}/{scaleKeys.length} →
            </button>
          )}
        </div>
      </div>
      {/* Notes pills */}
      <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
        {notes.map((n,i)=>{
          const isRoot=i===0;
          const isChordTone=CHORD_FORMULAS[chordType]?.intervals.includes(scaleInfo.formula[i]);
          return(
            <div key={i} style={{
              padding:'4px 8px',borderRadius:7,fontSize:12,fontFamily:'Georgia,serif',
              background:isRoot?scaleInfo.color+'33':isChordTone?scaleInfo.color+'18':'rgba(255,255,255,.04)',
              border:`1px solid ${isRoot?scaleInfo.color:isChordTone?scaleInfo.color+'55':'#1a1a28'}`,
              color:isRoot?scaleInfo.color:isChordTone?scaleInfo.color+'cc':'#3a3a4e',
              fontWeight:isRoot?700:isChordTone?500:300,
            }}>{n}{isRoot?'¹':''}</div>
          );
        })}
      </div>
      <div style={{fontSize:9,color:'#252535',letterSpacing:.5}}>
        ¹ Fondamentale · <span style={{color:scaleInfo.color+'66'}}>■</span> Note d'accord
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════
// PROGRESSION PICKER
// ═══════════════════════════════════════════════════════════════════

function ProgressionPicker({selected, onSelect, disabled}){
  const [openCat,setOpenCat]=useState(selected?PROGRESSIONS.find(p=>p.id===selected.id)?.cat:CATEGORIES[0]);

  return(
    <div style={{display:'flex',flexDirection:'column',gap:8,height:'100%'}}>
      {/* Category tabs */}
      <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
        {CATEGORIES.map(cat=>(
          <button key={cat} onClick={()=>setOpenCat(cat)}
            style={{
              padding:'5px 10px',borderRadius:8,fontSize:10,letterSpacing:1,
              background:openCat===cat?'rgba(255,179,0,.15)':'rgba(255,255,255,.03)',
              border:openCat===cat?'1px solid #FFB30066':'1px solid #1a1a28',
              color:openCat===cat?'#FFB300':'#3a3a4e',cursor:'pointer',transition:'all .15s',
            }}>{cat}</button>
        ))}
      </div>
      {/* Progression list */}
      <div style={{overflowY:'auto',display:'flex',flexDirection:'column',gap:4,flex:1}}>
        {PROGRESSIONS.filter(p=>p.cat===openCat).map(p=>{
          const isSel=selected?.id===p.id;
          return(
            <button key={p.id} onClick={()=>!disabled&&onSelect(p)} disabled={disabled}
              style={{
                padding:'8px 12px',borderRadius:10,textAlign:'left',
                background:isSel?'rgba(255,179,0,.12)':'rgba(255,255,255,.03)',
                border:isSel?'1px solid #FFB30077':'1px solid #141420',
                cursor:disabled?'not-allowed':'pointer',transition:'all .15s',
              }}>
              <div style={{fontSize:11,color:isSel?'#FFB300':'#8a8a9e',fontWeight:isSel?600:400,marginBottom:2}}>
                {p.name}
              </div>
              <div style={{fontSize:9,color:'#2a2a3a'}}>{p.desc}</div>
              <div style={{display:'flex',gap:4,marginTop:4,flexWrap:'wrap'}}>
                {p.chords.slice(0,8).map((c,i)=>(
                  <span key={i} style={{
                    fontSize:9,padding:'1px 5px',borderRadius:4,
                    background:'rgba(255,255,255,.04)',border:'1px solid #1e1e28',
                    color:'#3a3a4e',fontFamily:'Georgia,serif',
                  }}>{chordLabel(c.root,c.type)}</span>
                ))}
                {p.chords.length>8&&<span style={{fontSize:9,color:'#2a2a3a'}}>+{p.chords.length-8}</span>}
              </div>
            </button>
          );
        })}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════
// SESSIONS PANEL
// ═══════════════════════════════════════════════════════════════════

function SessionsPanel({onClose}){
  const [sessions,setSess]=useState(loadSessions);
  const fmt=d=>{const dt=new Date(d);return dt.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});};
  const acc=s=>s.score.total>0?Math.round(100*s.score.correct/s.score.total):0;
  const accColor=a=>a>=80?'#00E676':a>=50?'#FFB300':'#FF4081';
  return(
    <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.88)',display:'flex',
      alignItems:'flex-end',zIndex:200,backdropFilter:'blur(6px)'}} onClick={onClose}>
      <div onClick={e=>e.stopPropagation()} className="slide-up"
        style={{width:'100%',maxHeight:'70vh',background:'#0c0c1a',borderRadius:'20px 20px 0 0',
          border:'1px solid #1a1a2a',display:'flex',flexDirection:'column',overflow:'hidden'}}>
        <div style={{padding:'16px 20px',borderBottom:'1px solid #141420',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div style={{fontSize:13,letterSpacing:3,color:'#9e8b6e'}}>HISTORIQUE · {sessions.length} sessions</div>
          <div style={{display:'flex',gap:8}}>
            {sessions.length>0&&<button onClick={()=>{clearSess();setSess([]);}}
              style={{padding:'6px 12px',borderRadius:8,background:'rgba(255,23,68,.1)',border:'1px solid rgba(255,23,68,.3)',color:'#ff4468',fontSize:11,cursor:'pointer'}}>Effacer</button>}
            <button onClick={onClose}
              style={{padding:'6px 12px',borderRadius:8,background:'rgba(255,255,255,.05)',border:'1px solid #1e1e2e',color:'#666',fontSize:11,cursor:'pointer'}}>Fermer</button>
          </div>
        </div>
        <div style={{overflowY:'auto',padding:'12px 16px',display:'flex',flexDirection:'column',gap:6}}>
          {sessions.length===0&&<div style={{textAlign:'center',color:'#252535',padding:'40px',fontSize:12,fontStyle:'italic'}}>Aucune session</div>}
          {sessions.map(s=>{const a=acc(s);return(
            <div key={s.id} style={{background:'rgba(255,255,255,.025)',border:'1px solid #141420',borderRadius:12,padding:'10px 14px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div>
                <div style={{fontSize:11,color:'#c8c0b0',marginBottom:2}}>{s.prog}</div>
                <div style={{fontSize:9,color:'#3a3a4a',display:'flex',gap:10}}>
                  <span>♩ {s.bpm}</span><span>{s.bpc} t/acc</span>
                  {s.dur&&<span>{Math.floor(s.dur/60)}m{s.dur%60}s</span>}
                </div>
                <div style={{fontSize:8,color:'#1e1e2e',marginTop:2}}>{fmt(s.date)}</div>
              </div>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:22,fontWeight:200,color:accColor(a),fontFamily:'Georgia,serif'}}>{a}%</div>
                <div style={{fontSize:9,color:'#3a3a4a'}}>{s.score.correct}/{s.score.total}</div>
              </div>
            </div>
          );})}
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════════════════════════

function App(){
  // Layout
  const [isLandscape,setLandscape]=useState(window.innerWidth>window.innerHeight);
  useEffect(()=>{
    const h=()=>setLandscape(window.innerWidth>window.innerHeight);
    window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);
  },[]);

  // Practice state
  const [isRunning,setRunning]       = useState(false);
  const [isListening,setListening]   = useState(false);
  const [progression,setProgression] = useState(PROGRESSIONS[0]);
  const [bpm,setBpm]                 = useState(72);
  const [bpc,setBpc]                 = useState(2); // beats per chord
  const [clickVol,setClickVol]       = useState(0.5);
  const [scaleIdx,setScaleIdx]       = useState(0);
  const [transposeKey,setTranspose]  = useState(0); // semitone transposition
  const [showPicker,setShowPicker]   = useState(false);
  const [showSessions,setShowSess]   = useState(false);

  // Live state
  const [step,setStep]               = useState(0);
  const [beat,setBeat]               = useState(0);
  const [flash,setFlash]             = useState(false);
  const [noteStatus,setStatus]       = useState('idle');
  const [detectedChord,setDetChord]  = useState(null);
  const [score,setScore]             = useState({correct:0,total:0});

  // Refs
  const audioCtxRef   = useRef(null);
  const analyserRef   = useRef(null);
  const streamRef     = useRef(null);
  const rafRef        = useRef(null);
  const metroRef      = useRef(null);
  const beatCntRef    = useRef(0);
  const stepRef       = useRef(0);
  const stepResRef    = useRef('pending');
  const progressRef   = useRef(progression);
  const bpcRef        = useRef(bpc);
  const bpmRef        = useRef(bpm);
  const clickVolRef   = useRef(clickVol);
  const scoreRef      = useRef(score);
  const transpRef     = useRef(transposeKey);
  const sessStartRef  = useRef(null);

  useEffect(()=>{progressRef.current=progression;},[progression]);
  useEffect(()=>{bpcRef.current=bpc;},[bpc]);
  useEffect(()=>{bpmRef.current=bpm;},[bpm]);
  useEffect(()=>{clickVolRef.current=clickVol;},[clickVol]);
  useEffect(()=>{scoreRef.current=score;},[score]);
  useEffect(()=>{transpRef.current=transposeKey;},[transposeKey]);

  // Derived current chord
  const chords=useMemo(()=>
    progression.chords.map(c=>({...c,root:(c.root+transposeKey+12)%12}))
  ,[progression,transposeKey]);

  const currentChord = chords[step%chords.length];
  const nextChord    = chords[(step+1)%chords.length];
  const activeRoots  = useMemo(()=>new Set(chords.map(c=>c.root)),[chords]);

  // ── Mic ──────────────────────────────────────────────────────────
  const startMic=useCallback(async()=>{
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
      streamRef.current=stream;
      const ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
      audioCtxRef.current=ctx;
      const src=ctx.createMediaStreamSource(stream);
      const an=ctx.createAnalyser();
      an.fftSize=8192;an.smoothingTimeConstant=0.65;
      analyserRef.current=an;src.connect(an);
      setListening(true);
      const fd=new Float32Array(an.frequencyBinCount);
      const poll=()=>{
        an.getFloatFrequencyData(fd);
        const maxDb=Math.max(...Array.from(fd).slice(0,600));
        if(maxDb>-52){const c=detectChord(buildChroma(fd,44100,8192));setDetChord(c);}
        else setDetChord(null);
        rafRef.current=requestAnimationFrame(poll);
      };poll();
    }catch(err){alert('Micro refusé : '+err.message);}
  },[]);

  const stopMic=useCallback(()=>{
    cancelAnimationFrame(rafRef.current);
    try{analyserRef.current?.disconnect();audioCtxRef.current?.close();}catch{}
    streamRef.current?.getTracks().forEach(t=>t.stop());
    audioCtxRef.current=null;
    setListening(false);setDetChord(null);
  },[]);

  // ── Metronome ─────────────────────────────────────────────────────
  const stopMetronome=useCallback(()=>{
    clearInterval(metroRef.current);
    setRunning(false);beatCntRef.current=0;stepRef.current=0;
    setStep(0);setBeat(0);setStatus('idle');stepResRef.current='pending';
    // Save session
    if(sessStartRef.current&&scoreRef.current.total>0){
      saveSess({prog:progressRef.current.name,bpm:bpmRef.current,bpc:bpcRef.current,
        score:scoreRef.current,dur:Math.round((Date.now()-sessStartRef.current)/1000)});
    }
    sessStartRef.current=null;
  },[]);

  const startMetronome=useCallback(()=>{
    if(!isListening){alert('Activez le micro d\'abord !');return;}
    beatCntRef.current=0;stepRef.current=0;stepResRef.current='pending';
    setStep(0);setBeat(0);setStatus('listening');
    setScore({correct:0,total:0});sessStartRef.current=Date.now();
    setRunning(true);

    metroRef.current=setInterval(()=>{
      const b=beatCntRef.current%bpcRef.current;
      setBeat(b);setFlash(true);setTimeout(()=>setFlash(false),80);
      if(audioCtxRef.current) playClick(audioCtxRef.current,b===0,clickVolRef.current);

      if(b===bpcRef.current-1){
        const prog=progressRef.current;
        const transp=transpRef.current;
        const chd=prog.chords[stepRef.current%prog.chords.length];
        const expectedRoot=(chd.root+transp+12)%12;
        const expectedType=chd.type;

        if(stepResRef.current==='pending'){
          setDetChord(cur=>{
            let ok=false;
            if(cur){
              const rootOk=cur.root===expectedRoot;
              const maj=['maj','maj7','maj6','dom7','dom9','aug','sus2','sus4','dom7s11'];
              const min=['min','min7','min6','min7b5','dim','dim7'];
              const typeOk=maj.includes(expectedType)?maj.includes(cur.type):
                           min.includes(expectedType)?min.includes(cur.type):cur.type===expectedType;
              ok=rootOk&&typeOk;
            }
            setStatus(ok?'correct':'wrong');
            setScore(s=>{const ns={correct:s.correct+(ok?1:0),total:s.total+1};scoreRef.current=ns;return ns;});
            stepResRef.current='scored';
            return cur;
          });
        }
        setTimeout(()=>{
          stepRef.current=(stepRef.current+1)%prog.chords.length;
          setStep(stepRef.current);
          stepResRef.current='pending';setStatus('listening');
        },110);
      }
      beatCntRef.current++;
    },60000/bpmRef.current);
  },[isListening]);

  useEffect(()=>()=>{stopMetronome();stopMic();},[]);

  // ── Layout ────────────────────────────────────────────────────────
  const W=window.innerWidth,H=window.innerHeight;
  const circleSize=isLandscape?Math.min(H*.88,W*.46):Math.min(W*.9,H*.4);

  const acc=score.total>0?Math.round(100*score.correct/score.total):null;
  const statusColor=noteStatus==='correct'?'#00E676':noteStatus==='wrong'?'#FF1744':noteStatus==='listening'?'#FFB300':'#2a2a3e';

  // ── Chord list (progression strip) ───────────────────────────────
  const ChordStrip=()=>(
    <div style={{display:'flex',gap:5,overflowX:'auto',paddingBottom:4,
      scrollbarWidth:'none',WebkitOverflowScrolling:'touch'}}>
      {chords.map((c,i)=>{
        const isCur=i===step%chords.length&&isRunning;
        return(
          <div key={i} style={{
            flexShrink:0,padding:'5px 9px',borderRadius:8,textAlign:'center',
            background:isCur?`rgba(${COL[MAJ_ROOTS.indexOf(c.root%12)]||'255,179,0'},0.2)`:'rgba(255,255,255,.03)',
            border:`1px solid ${isCur?(COL[MAJ_ROOTS.indexOf(c.root%12)]||'#FFB300'):'#141420'}`,
            transition:'all .15s',
          }}>
            <div style={{fontSize:11,color:isCur?'#fff':'#4a4a5e',fontFamily:'Georgia,serif',fontWeight:isCur?700:400}}>
              {chordLabel(c.root,c.type,true)}
            </div>
            <div style={{fontSize:7,color:isCur?'#9a9ab0':'#252530',marginTop:1,letterSpacing:.5}}>
              {CHORD_FORMULAS[c.type]?.name.split(' ')[0]}
            </div>
          </div>
        );
      })}
    </div>
  );

  // ── Controls panel ────────────────────────────────────────────────
  const ControlPanel=()=>(
    <div style={{display:'flex',flexDirection:'column',gap:8,height:'100%',overflowY:'auto',
      padding:isLandscape?'0 4px':0}}>

      {/* Current chord info */}
      {currentChord&&(
        <div style={{
          background:`rgba(${noteStatus==='correct'?'0,230,118':noteStatus==='wrong'?'255,23,68':'255,179,0'},.08)`,
          border:`2px solid ${statusColor}`,borderRadius:16,padding:'12px 14px',
          boxShadow:`0 0 28px ${statusColor}22`,transition:'all .18s',
        }}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:8}}>
            <div>
              <div style={{fontSize:8,letterSpacing:3,color:'#3a3a4e',marginBottom:2}}>MAINTENANT</div>
              <div style={{fontSize:38,fontWeight:200,color:statusColor,lineHeight:1,fontFamily:'Georgia,serif'}}>
                {isRunning?chordLabel(currentChord.root,currentChord.type,true):'—'}
              </div>
              <div style={{fontSize:10,color:statusColor+'99',marginTop:2}}>
                {isRunning?CHORD_FORMULAS[currentChord.type]?.name:''}
              </div>
            </div>
            {nextChord&&isRunning&&(
              <div style={{textAlign:'right',opacity:.6}}>
                <div style={{fontSize:7,letterSpacing:2,color:'#2a2a3e',marginBottom:2}}>SUIVANT</div>
                <div style={{fontSize:22,fontWeight:200,color:'#4a4a5e',fontFamily:'Georgia,serif'}}>
                  {chordLabel(nextChord.root,nextChord.type,true)}
                </div>
              </div>
            )}
          </div>
          {/* Scale */}
          {isRunning&&<ScaleDisplay
            root={currentChord.root} chordType={currentChord.type}
            scaleIndex={scaleIdx} onCycleScale={()=>setScaleIdx(i=>(i+1)%((CHORD_SCALES[currentChord.type]||[]).length||1))}
          />}
        </div>
      )}

      {/* Chord strip */}
      <div style={{background:'rgba(255,255,255,.02)',border:'1px solid #141420',borderRadius:12,padding:'8px 10px'}}>
        <div style={{fontSize:8,letterSpacing:3,color:'#2a2a3e',marginBottom:6}}>PROGRESSION ({chords.length} accords)</div>
        <ChordStrip/>
      </div>

      {/* Beat + detected */}
      <div style={{display:'flex',gap:8}}>
        <div style={{flex:1,background:'rgba(255,255,255,.02)',border:'1px solid #141420',borderRadius:12,padding:'8px 10px',display:'flex',flexDirection:'column',alignItems:'center',gap:6}}>
          <div style={{fontSize:8,letterSpacing:2,color:'#2a2a3e'}}>TEMPO</div>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <button onClick={()=>!isRunning&&setBpm(b=>Math.max(30,b-5))}
              style={{width:26,height:26,borderRadius:7,background:'#0e0e1a',border:'1px solid #1a1a28',color:'#666',fontSize:14,cursor:'pointer'}}>–</button>
            <span style={{fontSize:18,color:'#c8c0b0',minWidth:36,textAlign:'center'}}>{bpm}</span>
            <button onClick={()=>!isRunning&&setBpm(b=>Math.min(220,b+5))}
              style={{width:26,height:26,borderRadius:7,background:'#0e0e1a',border:'1px solid #1a1a28',color:'#666',fontSize:14,cursor:'pointer'}}>+</button>
          </div>
          <BeatDots count={bpc} current={isRunning?beat:-1} flash={flash}/>
        </div>

        <div style={{flex:1,background:'rgba(255,255,255,.02)',border:'1px solid #141420',borderRadius:12,padding:'8px 10px',display:'flex',flexDirection:'column',alignItems:'center',gap:6}}>
          <div style={{fontSize:8,letterSpacing:2,color:'#2a2a3e'}}>TEMPS/ACCORD</div>
          <div style={{display:'flex',alignItems:'center',gap:6}}>
            <button onClick={()=>!isRunning&&setBpc(b=>Math.max(1,b-1))}
              style={{width:26,height:26,borderRadius:7,background:'#0e0e1a',border:'1px solid #1a1a28',color:'#666',fontSize:14,cursor:'pointer'}}>–</button>
            <span style={{fontSize:18,color:'#c8c0b0',minWidth:24,textAlign:'center'}}>{bpc}</span>
            <button onClick={()=>!isRunning&&setBpc(b=>Math.min(8,b+1))}
              style={{width:26,height:26,borderRadius:7,background:'#0e0e1a',border:'1px solid #1a1a28',color:'#666',fontSize:14,cursor:'pointer'}}>+</button>
          </div>
          <div style={{fontSize:8,color:'#2a2a3e',letterSpacing:1}}>CLIC
            <input type="range" min="0" max="1" step="0.05" value={clickVol}
              onChange={e=>setClickVol(+e.target.value)}
              style={{width:60,marginLeft:6,verticalAlign:'middle'}}/>
          </div>
        </div>
      </div>

      {/* Detected chord */}
      {isListening&&(
        <div style={{background:'rgba(255,255,255,.02)',border:'1px solid #141420',borderRadius:12,padding:'8px 12px',display:'flex',alignItems:'center',gap:10}}>
          <div style={{width:7,height:7,borderRadius:'50%',background:detectedChord?'#4CAF50':'#1a1a28',boxShadow:detectedChord?'0 0 8px #4CAF5088':'none',transition:'all .1s',flexShrink:0}}/>
          <div style={{flex:1}}>
            <div style={{fontSize:7,color:'#2a2a3e',letterSpacing:2}}>DÉTECTÉ (FFT)</div>
            <div style={{fontSize:16,color:detectedChord?'#c8e8d0':'#252535',fontFamily:'Georgia,serif'}}>
              {detectedChord?detectedChord.label:'—'}
              {detectedChord&&<span style={{fontSize:9,color:'#3a3a4e',marginLeft:6}}>{CHORD_FORMULAS[detectedChord.type]?.name}</span>}
            </div>
          </div>
          {acc!==null&&(
            <div style={{textAlign:'right'}}>
              <div style={{fontSize:20,fontWeight:200,color:acc>=70?'#00E676':acc>=40?'#FFB300':'#FF4081',fontFamily:'Georgia,serif'}}>{acc}%</div>
              <div style={{fontSize:8,color:'#2a2a3e'}}>{score.correct}/{score.total}</div>
            </div>
          )}
        </div>
      )}

      {/* Transpose */}
      <div style={{background:'rgba(255,255,255,.02)',border:'1px solid #141420',borderRadius:12,padding:'8px 12px'}}>
        <div style={{fontSize:8,letterSpacing:2,color:'#2a2a3e',marginBottom:6}}>TRANSPOSITION</div>
        <div style={{display:'flex',gap:3,flexWrap:'wrap'}}>
          {NOTES.map((n,i)=>(
            <button key={i} onClick={()=>!isRunning&&setTranspose(i)}
              style={{
                padding:'4px 7px',borderRadius:7,fontSize:10,fontFamily:'Georgia,serif',
                background:transposeKey===i?'rgba(255,179,0,.18)':'rgba(255,255,255,.03)',
                border:transposeKey===i?'1px solid #FFB30066':'1px solid #141420',
                color:transposeKey===i?'#FFB300':'#2a2a3e',cursor:isRunning?'not-allowed':'pointer',
              }}>{n}</button>
          ))}
        </div>
      </div>

      {/* Progression select button */}
      <button onClick={()=>!isRunning&&setShowPicker(true)}
        style={{
          padding:'10px 14px',borderRadius:12,textAlign:'left',
          background:'rgba(255,255,255,.03)',border:'1px solid #1e1e2e',cursor:isRunning?'not-allowed':'pointer',
        }}>
        <div style={{fontSize:8,letterSpacing:3,color:'#3a3a4e',marginBottom:2}}>PROGRESSION</div>
        <div style={{fontSize:12,color:'#8a8a9e'}}>{progression.name}</div>
      </button>

      {/* Start / Stop */}
      <button onClick={isRunning?stopMetronome:startMetronome}
        style={{
          padding:'14px',borderRadius:14,fontSize:14,fontWeight:600,letterSpacing:3,
          background:isRunning?'rgba(255,23,68,.2)':'rgba(255,179,0,.18)',
          border:isRunning?'2px solid #FF1744':'2px solid #FFB300',
          color:isRunning?'#FF6E6E':'#FFB300',cursor:'pointer',
          boxShadow:isRunning?'0 0 28px rgba(255,23,68,.2)':'0 0 28px rgba(255,179,0,.15)',
          transition:'all .2s',fontFamily:'Georgia,serif',
        }}>
        {isRunning?'■  STOP':'▶  START'}
      </button>
    </div>
  );

  // BeatDots used inside ControlPanel
  function BeatDots({count,current,flash}){
    return(
      <div style={{display:'flex',gap:4}}>
        {Array.from({length:count}).map((_,i)=>(
          <div key={i} style={{
            width:i===current?10:6,height:i===current?10:6,borderRadius:'50%',
            background:i===current?(flash?'#FFB300':'#8a6000'):'#141428',
            border:i===0?'1px solid #333':'1px solid #1e1e2e',
            boxShadow:i===current&&flash?'0 0 10px #FFB300':'none',transition:'all .06s',
          }}/>
        ))}
      </div>
    );
  }

  return(
    <div style={{
      width:'100%',height:'100%',background:'radial-gradient(ellipse at 20% 10%, #1a0e2e 0%, #06060f 55%)',
      display:'flex',flexDirection:isLandscape?'row':'column',
      color:'#e8dcc8',userSelect:'none',WebkitUserSelect:'none',
      padding:`env(safe-area-inset-top,8px) env(safe-area-inset-right,8px) env(safe-area-inset-bottom,8px) env(safe-area-inset-left,8px)`,
      gap:isLandscape?12:8,overflow:'hidden',
    }}>

      {/* ── Left panel (circle) ───────────────────────────────────── */}
      <div style={{
        display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',
        flexShrink:0,gap:8,
        width:isLandscape?circleSize+20:'100%',
        padding:isLandscape?'8px 0':'4px 0',
      }}>
        {/* Header */}
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',width:'100%',paddingInline:isLandscape?8:16}}>
          <div>
            <div style={{fontSize:8,letterSpacing:5,color:'#2e2e3e',textTransform:'uppercase'}}>Cycle des quintes</div>
            <div style={{fontSize:16,fontWeight:400,letterSpacing:1,color:'#d8ccb8'}}>Quintessence</div>
          </div>
          <div style={{display:'flex',gap:6}}>
            <button onClick={isListening?stopMic:startMic}
              style={{padding:'6px 12px',borderRadius:9,fontSize:10,letterSpacing:1,
                background:isListening?'rgba(244,67,54,.15)':'rgba(255,255,255,.05)',
                border:isListening?'1px solid #F4433688':'1px solid #1e1e2e',
                color:isListening?'#F44336':'#555',cursor:'pointer'}}>
              {isListening?'⏹ Mic':'🎙 Mic'}
            </button>
            <button onClick={()=>setShowSess(true)}
              style={{width:34,height:34,borderRadius:9,background:'rgba(255,255,255,.04)',
                border:'1px solid #1a1a28',color:'#555',fontSize:14,cursor:'pointer'}}>📋</button>
          </div>
        </div>

        <CircleSVG
          size={circleSize}
          currentRoot={isRunning?currentChord?.root:null}
          nextRoot={isRunning?nextChord?.root:null}
          chordType={isRunning?currentChord?.type:'maj'}
          noteStatus={noteStatus}
          activeRoots={activeRoots}
        />
      </div>

      {/* ── Right panel (controls) ────────────────────────────────── */}
      <div style={{
        flex:1,overflowY:'auto',
        padding:isLandscape?'8px 8px 8px 4px':'0 12px 8px',
        display:'flex',flexDirection:'column',gap:8,
        minWidth:0,
      }}>
        <ControlPanel/>
      </div>

      {/* ── Modals ───────────────────────────────────────────────── */}
      {showPicker&&(
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.9)',zIndex:100,
          display:'flex',flexDirection:'column',padding:16,gap:12,backdropFilter:'blur(6px)'}} className="slide-up">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{fontSize:14,letterSpacing:3,color:'#9e8b6e'}}>PROGRESSIONS</div>
            <button onClick={()=>setShowPicker(false)}
              style={{padding:'7px 16px',borderRadius:10,background:'rgba(255,255,255,.06)',
                border:'1px solid #2a2a3a',color:'#888',fontSize:12,cursor:'pointer'}}>Fermer</button>
          </div>
          <div style={{flex:1,overflowY:'auto'}}>
            <ProgressionPicker selected={progression}
              onSelect={p=>{setProgression(p);setScaleIdx(0);setShowPicker(false);}}
              disabled={isRunning}/>
          </div>
        </div>
      )}

      {showSessions&&<SessionsPanel onClose={()=>setShowSess(false)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
